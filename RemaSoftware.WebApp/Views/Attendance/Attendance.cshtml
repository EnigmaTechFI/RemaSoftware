@using RemaSoftware.Domain.Models
@model RemaSoftware.WebApp.Models.EmployeeViewModel.AttendanceViewModel

@{
    ViewData["Title"] = "Gestione Presenze";
}

<link rel="stylesheet" href="~/lib/datatables/dataTables.bootstrap4.min.css"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTales Example -->
<div class="card shadow mb-4">
    <div class="d-sm-flex align-items-center justify-content-between card-header py-3">
        <h3 class="m-0 font-weight-bold text-primary">Gestione Presenze</h3>
    </div>
    <form method="get" action="/Attendance/Attendance">
        <div class="row mb-4">
            <div class="col-2 mt-3 ml-3">
                <label for="mese">Mese:</label>
                <select id="mese" name="month" class="form-control">
                    <option value="01" selected="@(Model.Month == 01)">Gennaio</option>
                    <option value="02" selected="@(Model.Month == 02)">Febbraio</option>
                    <option value="03" selected="@(Model.Month == 03)">Marzo</option>
                    <option value="04" selected="@(Model.Month == 04)">Aprile</option>
                    <option value="05" selected="@(Model.Month == 05)">Maggio</option>
                    <option value="06" selected="@(Model.Month == 06)">Giugno</option>
                    <option value="07" selected="@(Model.Month == 07)">Luglio</option>
                    <option value="08" selected="@(Model.Month == 08)">Agosto</option>
                    <option value="09" selected="@(Model.Month == 09)">Settembre</option>
                    <option value="10" selected="@(Model.Month == 10)">Ottobre</option>
                    <option value="11" selected="@(Model.Month == 11)">Novembre</option>
                    <option value="12" selected="@(Model.Month == 12)">Dicembre</option>
                </select>


            </div>
            <div class="col-2 mt-3">
                <label for="anno">Anno:</label>
                <select id="anno" name="year" class="form-control">
                    <option value="2023" selected="@(Model.Year == 2023)">2023</option>
                    <option value="2024" selected="@(Model.Year == 2024)">2024</option>
                    <option value="2025" selected="@(Model.Year == 2025)">2025</option>
                </select>
            </div>
            <div class="col-2 mt-5">
                <input type="submit" value="Visualizza" class="btn btn-primary text-white"/>
            </div>
            <div class="col-2 mt-5">
                <input data-toggle="modal" data-target="#new-modal" type="button" value="Aggiungi a tutti" class="btn btn-primary text-white" id="exportBtn" onclick="AllEmployeeAttendanceId('#modify-modal')"/>
            </div>
            <div class="col-2 mt-5">
                <input type="button" data-toggle="modal" data-target="#modaltxt" value="Invia documento di testo" class="btn btn-primary text-white" id="sendTXT"/>
            </div>
        </div>
        <div class="row mb-2">
            <div class="ml-5" style="width: 20px; height: 20px; background-color: green; border-radius: 5px;"></div><div style="color: black; margin-left: 5px;"> Presenza</div>
            <div class="ml-5" style="width: 20px; height: 20px; background-color: red; border-radius: 5px;"></div><div style="color: black; margin-left: 5px;"> Assenza</div>
            <div class="ml-5" style="width: 20px; height: 20px; background-color: orange; border-radius: 5px;"></div><div style="color: black; margin-left: 5px;"> Malattia</div>
            <div class="ml-5" style="width: 20px; height: 20px; background-color: #36b9cc; border-radius: 5px;"></div><div style="color: black; margin-left: 5px;"> Festivo</div>
            <div class="ml-5" style="width: 20px; height: 20px; background-color: #f6c23e; border-radius: 5px;"></div><div style="color: black; margin-left: 5px;"> Ferie</div>
        </div>
    </form>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="table-stock" width="100%" cellspacing="0">
                <tr>
                    <th>Impiegato</th>
                    @for (int giorno = 1; giorno <= DateTime.DaysInMonth(Model.Year, Model.Month); giorno++)
                    {
                        DateTime dataCorrente = new DateTime(Model.Year, Model.Month, giorno);
                        if (dataCorrente.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
                        {
                            <th class="text-center" style="background-color: #d3d3d3;">@giorno</th>
                        }
                        else
                        {
                            <th class="text-center">@giorno</th>
                        }
                    }
                    <td><b>Totale ore</b></td>
                </tr>

                @foreach (var presenza in Model.Attendances.GroupBy(a => a.Employee))
                {
                    <tr onclick="SetEmployeeAttendanceId('#new-modal', @presenza.Key.EmployeeID)">
                        <td style="width: 150px;">
                            <div style="display: inline-block; white-space: nowrap; box-sizing: border-box; width: 80%; float:  left;">
                                <div style="white-space: nowrap; font-size:  18px;"><b>@presenza.Key.Name </b></div>
                                <div style="white-space: nowrap; font-size:  18px;"><b> @presenza.Key.Surname</b> </div>
                            </div>
                            <button style="display: inline-block; cursor: pointer; border: 0px; background-color: white; box-sizing: border-box; width: 20%; float:  right;" title="Nuova Entrata/Uscita" data-toggle="modal" data-target="#new-modal">
                                <span style="color: green; font-weight: bold; font-size: 30px; line-height: 40px; display: inline-block; text-align: center; width: 100%;">+</span>
                            </button>
                        </td>
                        @for (int giorno = 1; giorno <= DateTime.DaysInMonth(Model.Year, Model.Month); giorno++)
                        {
                            DateTime dataCorrente = new DateTime(Model.Year, Model.Month, giorno);
                            var attendancesForDay = presenza.Where(a => a.DateIn.Day == giorno);

                            if (dataCorrente.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
                            {
                                <td style="background-color: #ededed;">
                                    @foreach (var presence in attendancesForDay)
                                    {
                                        <a style="cursor: pointer;" data-toggle="modal" data-target="#modify-modal" onclick="SetDataAttendanceId('#modify-modal', @presence.AttendanceID), SetDataAttendanceId('#confirm-del-modal', @presence.AttendanceID)">
                                            @if (presence.Type == "Presenza")
                                            {
                                                <div style="color: white; background-color: green; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Presenza">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Assenza")
                                            {
                                                <div style="color: white; background-color: red; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Assenza">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Malattia")
                                            {
                                                <div style="color: white; background-color: #F17831; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Malattia">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Festivo")
                                            {
                                                <div style="color: white; background-color: #36b9cc; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Festivo">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Ferie")
                                            {
                                                <div style="color: white; background-color: #f6c23e; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Ferie">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                        </a>
                                    }
                                </td>
                            }
                            else
                            {
                                <td>
                                    @foreach (var presence in attendancesForDay)
                                    {
                                        <a style="cursor: pointer;" title="Modifica Entrata/Uscita" data-toggle="modal" data-target="#modify-modal" onclick="SetDataAttendanceId('#modify-modal', @presence.AttendanceID), SetDataAttendanceId('#confirm-del-modal', @presence.AttendanceID)">
                                            @if (presence.Type == "Presenza")
                                            {
                                                <div style="color: white; background-color: green; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Presenza">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Assenza")
                                            {
                                                <div style="color: white; background-color: red; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Assenza">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Malattia")
                                            {
                                                <div style="color: white; background-color: #F17831; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Malattia">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Festivo")
                                            {
                                                <div style="color: white; background-color: #36b9cc; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Festivo">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                            @if (presence.Type == "Ferie")
                                            {
                                                <div style="color: white; background-color: #f6c23e; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Ferie">
                                                    <b style="white-space: nowrap;">@(presence.DateIn.ToString(@"HH\:mm"))-@(presence.DateOut?.ToString(@"HH\:mm"))</b>
                                                </div>
                                            }
                                        </a>
                                    }
                                </td>
                            }
                        }
                        
                        @{
                            TimeSpan? totalTimePresence = TimeSpan.Zero;
                            TimeSpan? totalTimeAbsence = TimeSpan.Zero;
                            TimeSpan? totalTimeIllness = TimeSpan.Zero;
                            TimeSpan? totalTimeHoliday = TimeSpan.Zero;
                            TimeSpan? totalTimeVacation = TimeSpan.Zero;
                            
                            foreach (var item in presenza)
                            {
                                if (item.Type == "Presenza" && item.DateOut != null)
                                    totalTimePresence += item.DateOut - item.DateIn;
                                
                                if (item.Type == "Assenza" && item.DateOut != null)
                                    totalTimeAbsence += item.DateOut - item.DateIn;
                                
                                if (item.Type == "Malattia" && item.DateOut != null)
                                    totalTimeIllness += item.DateOut - item.DateIn;
                                
                                if (item.Type == "Festivo" && item.DateOut != null)
                                    totalTimeHoliday += item.DateOut - item.DateIn;
                                
                                if (item.Type == "Ferie" && item.DateOut != null)
                                    totalTimeVacation += item.DateOut - item.DateIn;
                            }
                        }

                        <td>
                            @if (totalTimePresence != TimeSpan.Zero)
                            {
                                <div class="text-center" style="color: white; background-color: green; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Totale ore presenza">
                                    <b style="white-space: nowrap;">@(totalTimePresence?.ToString(@"hh\:mm")) h</b>
                                </div>
                            }
                            @if (totalTimeAbsence != TimeSpan.Zero)
                            {
                                <div class="text-center" style="color: white; background-color: red; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Totale ore assenza">
                                    <b style="white-space: nowrap;">@(totalTimeAbsence?.ToString(@"hh\:mm")) h</b>
                                </div>
                            }
                            @if (totalTimeIllness != TimeSpan.Zero)
                            {
                                <div class="text-center" style="color: white; background-color: #F17831; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Totale ore malattia">
                                    <b style="white-space: nowrap;">@(totalTimeIllness?.ToString(@"hh\:mm")) h</b>
                                </div>
                            }
                            @if (totalTimeHoliday != TimeSpan.Zero)
                            {
                                <div class="text-center" style="color: white; background-color: #36b9cc; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Totale ore festivo">
                                    <b style="white-space: nowrap;">@(totalTimeHoliday?.ToString(@"hh\:mm")) h</b>
                                </div>
                            }
                            @if (totalTimeVacation != TimeSpan.Zero)
                            {
                                <div class="text-center" style="color: white; background-color: #f6c23e; border-radius: 10px; padding: 2px 3px 2px 3px; margin-bottom: 3px;" title="Totale ore ferie">
                                    <b style="white-space: nowrap;">@(totalTimeVacation?.ToString(@"hh\:mm")) h</b>
                                </div>
                            }

                        </td>
                    </tr>
                }


                @foreach (var employee in Model.Employees)
                {
                    <tr onclick="SetEmployeeAttendanceId('#new-modal', @employee.EmployeeID)">
                        <td>
                            <div style="display: inline-block; white-space: nowrap; box-sizing: border-box; width: 80%; float:  left;">
                                <div style="white-space: nowrap; font-size:  18px;"><b>@employee.Name </b></div>
                                <div style="white-space: nowrap; font-size:  18px;"><b> @employee.Surname</b> </div>
                            </div>
                            <button style="display: inline-block; cursor: pointer; border: 0px; background-color: white; box-sizing: border-box; width: 20%; float:  right;" title="Nuova Entrata/Uscita" data-toggle="modal" data-target="#new-modal">
                                <span style="color: green; font-weight: bold; font-size: 30px; line-height: 40px; display: inline-block; text-align: center; width: 100%;">+</span>
                            </button>
                        </td>
                        @for (int giorno = 1; giorno <= DateTime.DaysInMonth(Model.Year, Model.Month); giorno++)
                        {
                            DateTime dataCorrente = new DateTime(Model.Year, Model.Month, giorno);
                            @if (dataCorrente.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
                            {
                                <td style="background-color: #ededed;">
                                </td>
                            }
                            else
                            {
                                <td>
                                </td>
                            }
                        }
                    </tr>
                }
            </table>

        </div>
    </div>
</div>

<div class="modal fade" id="confirm-del-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Conferma eliminazione</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Sei sicuro di voler eliminare questa presenza?</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Annulla</button>
                <button class="btn btn-danger" onclick="DeleteAttendance()">Elimina</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modify-modal" tabindex="-1" role="dialog" aria-labelledby="modal-head" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-head">Modifica Ingresso/Uscita</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="pb-2 font-italic h6">Inserire la modifica degli orari di ingresso/uscita:</p>
                <div class="row">
                    <div class="col-6">
                        <label class="form-check-label"><b>Orario Ingresso</b></label>
                        <input class="form-control" type="time" id="ModifyIn"/>

                    </div>
                    <div class="col-6">
                        <label class="form-check-label"><b>Orario Uscita</b></label>
                        <input class="form-control" type="time" id="ModifyOut" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" style="float: left; margin-right: 25%;" data-toggle="modal" data-target="#confirm-del-modal" data-dismiss="modal">Elimina presenza</button>
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="ModifyAttendance()">Conferma</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="new-modal" tabindex="-1" role="dialog" aria-labelledby="modal-head" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-head">Aggiungi Ingresso/Uscita</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="pb-2 font-italic h6">Inserire i nuovi orari di ingresso/uscita:</p>
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-check-label"><b>Data</b></label>
                        <input class="form-control" type="date" id="DataInOut" />
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-check-label"><b>Tipo di registrazione</b></label>
                        <select id="Type" class="form-control">
                            <option selected="selected" value="Presenza">Presenza</option>
                            <option value="Assenza">Assenza</option>
                            <option value="Festivo">Festivo</option>
                            <option value="Malattia">Malattia</option>
                            <option value="Ferie">Ferie</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-check-label"><b>Orario Ingresso</b></label>
                        <input class="form-control" type="time" id="TimeIn"/>

                    </div>
                    <div class="col-6">
                        <label class="form-check-label"><b>Orario Uscita</b></label>
                        <input class="form-control" type="time" id="TimeOut" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Annulla</button>
                <button class="btn btn-primary" onclick="NewAttendance()">Conferma</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modaltxt" tabindex="-1" role="dialog" aria-labelledby="modal-head" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-head">Invio dei dati per mail </h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="pb-2 font-italic h6">Modificare mail se necessario:</p>
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-check-label"><b>Mail</b></label>
                        <input class="form-control" type="email" id="mailsend" value="alessio.corsi.lv@gmail.com" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Annulla</button>
                <button class="btn btn-primary" onclick="SendAttendance()">Invia</button>
            </div>
        </div>
    </div>
</div>

@section Scripts
{

    <script>
        
        function SetDataAttendanceId(elementName, attendanceId){
            $(elementName).data("attendanceId", attendanceId);
        }
    
        function SetEmployeeAttendanceId(elementName, employeeId){
            $(elementName).data("employeeId", employeeId);
        }
        
        function SetDataAttendance(elementName, data){
            $(elementName).data("data", data);
        }
        
        function AllEmployeeAttendanceId(elementName){
            $(elementName).data("employeeId", null);
        }
        
        function DeleteAttendance() {
            var attendanceId = $("#confirm-del-modal").data("attendanceId");
            $.ajax({
                url: '/Attendance/DeleteAttendance',
                type: 'POST',
                data: { attendanceId: attendanceId },
                success: function (data) {
                    $("#confirm-del-modal").modal('toggle');
                    console.log('Eliminazione completata');
                },
                error: function (xhr, status, error) {
                    $("#confirm-del-modal").modal('toggle');
                    console.log('Errore durante l\'eliminazione della presenza:');
                }
            });
        }
        
        function ModifyAttendance() {
            var attendanceId = $("#modify-modal").data("attendanceId");

            var model = {
                attendanceId: attendanceId,
                InId: $('#ModifyIn').val(),
                OutId: $('#ModifyOut').val()
            }
        
            $.post('@Url.Action("ModifyAttendance", "Attendance")', model, function (data){
                $("#modify-modal").modal('toggle');
            });
        }
        
        function NewAttendance(){
            var employeeId = $("#new-modal").data("employeeId");
            
            var dataInOut = $('#DataInOut').val();
            var timeIn = $('#TimeIn').val();
            var timeOut = $('#TimeOut').val();
            var type = $('#Type').val();
            
            var inDateTime = moment(dataInOut + ' ' + timeIn, 'YYYY-MM-DD HH:mm').utcOffset('+02:00');
            var outDateTime = moment(dataInOut + ' ' + timeOut, 'YYYY-MM-DD HH:mm').utcOffset('+02:00');
            
            var inIdFormatted = inDateTime.format('YYYY-MM-DD HH:mm:ss');
            var outIdFormatted = outDateTime.format('YYYY-MM-DD HH:mm:ss');
            
            var model = {
                attendanceId: employeeId,
                InId: inIdFormatted,
                OutId: outIdFormatted,
                Type: type
            }
            if (employeeId != null){
                $.post('@Url.Action("NewAttendance", "Attendance")', model, function (data){
                    $("#new-modal").modal('toggle');
                });
            }else{
                $.post('@Url.Action("NewAllAttendance", "Attendance")', model, function (data){
                    $("#new-modal").modal('toggle');
                });
            }
        }
            
        function SendAttendance() {
           var month = $('#mese').val();
           var year = $('#anno').val();
           var mail = $('#mailsend').val();
       
           var model = {
               month: month,
               year: year,
               mail: mail
           }
       
           $.ajax({
               url: '@Url.Action("SendAttendance", "Attendance")',
               type: 'POST',
               data: model,
               success: function () {
                   $("#modaltxt").modal('toggle');
               },
               error: function () {
                   // Gestione dell'errore (se necessario)
               }
           });
        }
         
    </script>

}